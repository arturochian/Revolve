## Georges needs to add comments...

##' Model implementing "Huisman, J., and Weissing, F.J. (2001).
##' Biological conditions for oscillations and chaos generated by multispecies
##' competition. Ecology 82, 2682â€“2695..
##'
##' Test case...
##' @title Huisman & Weissing 2001
##' @param m Mortality rate
##' @param D Resource turnover rate
##' @param S Supply rate
##' @param n Number of species
##' @param k Number of resources
##' @author Georges Kunstler and Rich FitzJohn
##' @export
make_huisman_2001<- function(m=0.25, D=0.25, S=c(1, 1), n=2L, k=2L) {
  defaults <- list(m=m, D=D, S=S, n=n, k=k)
  parameters <- make_parameters(defaults, environment())
  if (n != 2 || k != 2) {
    stop("Not yet implemented/tested")
  }

  dydt <- function(t, ode.y, x, ...) {
    i <- seq_len(k) # index to resources
    R <- ode.y[i]
    y <- ode.y[-i]
    gi <- g(x, R)
    dRdt <- D * (S - R) - colSums(y * gi * cbind(x, 1-x) )
    dydt <- y * (gi - m)
    c(dRdt, dydt)
  }

  ## Given traits 'x' and initial densities 'y', compute the
  ## equilibrium.  Return the equilibrium resource availability at the
  ## same time.
  equilibrium <- function(x, y, method="runsteady",
                          init_time=200,
                          max_time=1e5) {
    # Initial resources are set to 'S'
    ans <- equilibrium_(dydt, x, c(S, y), method, init_time, max_time)
    i <- seq_len(k) # index to resources
    list(R=ans[i], y=ans[-i])
  }

  run <- function(x, y, times) {
    y0 <- c(S, y)
    res <- lsoda_nolist(y0, times, dydt, x)
    i.t <- 1
    i.R <- seq(2,   length=k)
    i.y <- seq(k+2, length=n)
    list(t=res[,i.t], R=res[,i.R], y=res[,i.y])
  }

  # TODO: Hard coded for two strategies.  Also for two species?
  g <- function(x, R) {
    pmin(R[1]/(   x    +  R[1]),
         R[2]/((1 - x) +  R[2]))
  }


  ret <- list(equilibrium  = equilibrium,
              run          = run,
              parameters   = parameters)
  class(ret) <- "model"
  ret
}
